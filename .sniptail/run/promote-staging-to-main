#!/usr/bin/env bash
set -euo pipefail

readonly SOURCE_BRANCH="staging"
readonly TARGET_BRANCH="main"
readonly PR_TITLE="chore: promote staging to main"
readonly API_BASE_URL="https://api.github.com"

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "$cmd is required for promote-staging-to-main." >&2
    exit 1
  fi
}

extract_json_field() {
  local json_input="$1"
  local jq_expr="$2"

  if command -v jq >/dev/null 2>&1; then
    printf '%s' "$json_input" | jq -r "$jq_expr"
    return 0
  fi

  if command -v python3 >/dev/null 2>&1; then
    JSON_INPUT="$json_input" PYTHON_EXPR="$jq_expr" python3 <<'PY'
import json
import os

payload = json.loads(os.environ["JSON_INPUT"])
expr = os.environ["PYTHON_EXPR"]

if expr == '.[0].html_url // ""':
  if isinstance(payload, list) and payload:
    print((payload[0] or {}).get("html_url", ""))
  else:
    print("")
elif expr == '.html_url // ""':
  if isinstance(payload, dict):
    print(payload.get("html_url", ""))
  else:
    print("")
else:
  raise SystemExit(f"Unsupported expression: {expr}")
PY
    return 0
  fi

  echo "jq or python3 is required to parse GitHub API responses." >&2
  exit 1
}

parse_github_repo() {
  local remote_url="$1"
  local path=""

  case "$remote_url" in
    git@github.com:*)
      path="${remote_url#git@github.com:}"
      ;;
    ssh://git@github.com/*)
      path="${remote_url#ssh://git@github.com/}"
      ;;
    https://github.com/*)
      path="${remote_url#https://github.com/}"
      ;;
    *)
      return 1
      ;;
  esac

  path="${path%.git}"
  if [[ "$path" != */* ]]; then
    return 1
  fi

  printf '%s\n' "$path"
}

require_cmd git
require_cmd curl

origin_url="$(git remote get-url origin)"
repo_path="$(parse_github_repo "$origin_url" || true)"
if [[ -z "$repo_path" ]]; then
  echo "origin must point to a GitHub repository. Current origin: $origin_url" >&2
  exit 1
fi

owner="${repo_path%%/*}"
repo="${repo_path#*/}"

if [[ -z "$owner" || -z "$repo" ]]; then
  echo "Failed to parse GitHub owner/repo from origin: $origin_url" >&2
  exit 1
fi

github_token="${GITHUB_API_TOKEN:-${GH_TOKEN:-${GITHUB_TOKEN:-}}}"
if [[ -z "$github_token" ]]; then
  echo "Missing GitHub token. Set GITHUB_API_TOKEN (or GH_TOKEN/GITHUB_TOKEN)." >&2
  exit 1
fi

echo "Fetching latest refs for $SOURCE_BRANCH and $TARGET_BRANCH..."
git fetch origin "$SOURCE_BRANCH" "$TARGET_BRANCH"

commits_to_promote="$(git rev-list --count "origin/$TARGET_BRANCH..origin/$SOURCE_BRANCH")"
if [[ "$commits_to_promote" -eq 0 ]]; then
  echo "No commits to promote from $SOURCE_BRANCH to $TARGET_BRANCH."
  exit 0
fi

echo "Checking for existing open PR from $SOURCE_BRANCH to $TARGET_BRANCH..."
existing_pr_response="$(
  curl --silent --show-error --fail --get \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer $github_token" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    --data-urlencode "state=open" \
    --data-urlencode "head=$owner:$SOURCE_BRANCH" \
    --data-urlencode "base=$TARGET_BRANCH" \
    "$API_BASE_URL/repos/$owner/$repo/pulls"
)"

existing_pr_url="$(extract_json_field "$existing_pr_response" '.[0].html_url // ""')"
if [[ -n "$existing_pr_url" ]]; then
  echo "Open promotion PR already exists: $existing_pr_url"
  exit 0
fi

read -r -d '' pr_payload <<JSON || true
{
  "title": "$PR_TITLE",
  "head": "$SOURCE_BRANCH",
  "base": "$TARGET_BRANCH",
  "body": "Automated promotion PR from \`$SOURCE_BRANCH\` to \`$TARGET_BRANCH\` created by Sniptail run action \`promote-staging-to-main\`."
}
JSON

echo "Creating promotion PR..."
created_pr_response="$(
  curl --silent --show-error --fail \
    -X POST \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer $github_token" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    -d "$pr_payload" \
    "$API_BASE_URL/repos/$owner/$repo/pulls"
)"

created_pr_url="$(extract_json_field "$created_pr_response" '.html_url // ""')"
if [[ -z "$created_pr_url" ]]; then
  echo "PR created but response did not include html_url." >&2
  exit 1
fi

echo "Created promotion PR: $created_pr_url"
