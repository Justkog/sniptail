FROM node:22-bookworm-slim

ARG PNPM_VERSION=10.5.0

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl git openssh-client bash \
    ripgrep patch procps less \
  && rm -rf /var/lib/apt/lists/*

# non-root user
RUN useradd -m -s /bin/bash codex \
  && mkdir -p /home/codex/.cache/node/corepack /home/codex/.npm-global \
  && chown -R codex:codex /home/codex

# Enable Corepack shims in system paths.
RUN corepack enable

USER codex
WORKDIR /home/codex

# Ensure runtime cache paths are writable and deterministic.
ENV XDG_CACHE_HOME=/home/codex/.cache
ENV COREPACK_HOME=/home/codex/.cache/node/corepack
ENV COREPACK_DEFAULT_TO_LATEST=0

# Install global npm packages into the user home to avoid needing root.
ENV NPM_CONFIG_PREFIX=/home/codex/.npm-global
ENV PATH=/home/codex/.npm-global/bin:${PATH}

# Preload exact pnpm into runtime Corepack cache and install pinned pnpm binary.
RUN corepack prepare "pnpm@${PNPM_VERSION}" --activate \
  && npm install -g "@openai/codex" "pnpm@${PNPM_VERSION}" \
  && test "$(pnpm --version)" = "${PNPM_VERSION}" \
  && test "$(corepack pnpm --version)" = "${PNPM_VERSION}"

ENTRYPOINT ["codex"]
