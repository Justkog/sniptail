FROM node:22-bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl git openssh-client bash \
    ripgrep patch procps less \
  && rm -rf /var/lib/apt/lists/*

# Enable pnpm via Corepack (needs root to write /usr/local/bin).
RUN corepack enable && corepack prepare pnpm@latest --activate

# non-root user
RUN useradd -m -s /bin/bash copilot
USER copilot
WORKDIR /home/copilot

# Install global npm packages into the user home to avoid needing root.
ENV NPM_CONFIG_PREFIX=/home/copilot/.npm-global
ENV PATH=/home/copilot/.npm-global/bin:${PATH}
RUN npm install -g @github/copilot

ENTRYPOINT ["copilot"]